<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Digital Truth: Спаси Правду</title>
<style>
  :root{
    --bg:#0b0f14; --card:#0f1621; --ink:#eaf2ff; --muted:#9bb0cc;
    --acc:#53e2ae; --warn:#ff7a7a; --accent2:#7aa9ff; --shadow:rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background: radial-gradient(1200px 700px at 70% -10%, #132033 0%, #0b0f14 45%);
    color:var(--ink);
  }
  header{
    padding:18px 20px; display:flex; align-items:center; justify-content:space-between;
    border-bottom:1px solid #1f2a3a; backdrop-filter: blur(6px); position:sticky; top:0; z-index:5;
    background:linear-gradient(180deg, rgba(15,22,33,.9), rgba(15,22,33,.6));
  }
  header h1{margin:0; font-size:18px; letter-spacing:.5px}
  #rep, #caseNo {font-size:14px; color:var(--muted)}
  main{max-width:980px; margin:24px auto; padding:0 16px 48px}
  .panel{
    background:var(--card); border:1px solid #1e2a3b; border-radius:14px; box-shadow:0 10px 30px var(--shadow);
    padding:18px; margin-bottom:16px;
  }
  .hero{display:flex; gap:16px; align-items:center}
  .hero .badge{font-size:12px; color:#0b0f14; background:linear-gradient(135deg, var(--acc), #8ef8cd);
    padding:6px 10px; border-radius:999px; font-weight:600}
  .title{font-size:22px; margin:6px 0 2px}
  .subtitle{font-size:14px; color:var(--muted); margin:0}
  .grid{display:grid; gap:12px}
  @media(min-width:860px){ .grid{grid-template-columns:1.1fr 1fr} }
  .evidence{display:grid; gap:10px}
  .card{
    background:#0c121b; border:1px solid #1e2a3b; border-radius:12px; padding:12px;
  }
  .meta{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px}
  .tag{font-size:11px; color:var(--muted); border:1px dashed #2a3a55; padding:2px 6px; border-radius:6px}
  .text{font-size:15px; line-height:1.45}
  .controls{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
  button{
    cursor:pointer; border:1px solid #24354d; background:#101826; color:var(--ink);
    padding:10px 14px; border-radius:10px; font-weight:600
  }
  button.primary{background:linear-gradient(135deg, var(--accent2), #5fe1ff); color:#09111c; border:none}
  button.truth{border-color:#2b4; background:rgba(83,226,174,.1)}
  button.lie{border-color:#b33; background:rgba(255,122,122,.1)}
  button.ghost{background:transparent}
  button:disabled{opacity:.55; cursor:not-allowed}
  .choice{display:grid; gap:10px}
  .choice .opt{display:flex; gap:10px; align-items:flex-start; padding:12px; border:1px solid #223047; border-radius:10px; background:#0c121b}
  .opt input{transform:translateY(2px)}
  .footerRow{display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap}
  .scoreline{font-size:14px; color:var(--muted)}
  .toast{position:fixed; right:16px; bottom:16px; background:#0f1a28; border:1px solid #20324a; color:var(--ink);
         padding:10px 12px; border-radius:10px; box-shadow:0 10px 30px var(--shadow); opacity:0; transform:translateY(8px);
         transition:.25s}
  .toast.show{opacity:1; transform:translateY(0)}
  .end{
    text-align:center; padding:24px 16px; display:grid; gap:12px; place-items:center
  }
  .end h2{margin:0}
  .rank{font-size:13px; color:#0b0f14; background:linear-gradient(135deg, var(--acc), #c0ffd9); padding:6px 10px; border-radius:999px; font-weight:700}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; background:#0b1220; padding:2px 6px; border:1px solid #1e2a3b; border-radius:6px; color:var(--muted)}
   .opt-radio{display:flex; gap:8px; align-items:center; cursor:pointer; font-size:14px}
   .opt-radio input{accent-color:var(--acc); cursor:pointer; margin:0}
   input[type="text"], input[type="email"], select{transition:.2s; outline:none}
   input[type="text"]:focus, input[type="email"]:focus, select:focus{border-color:var(--acc); box-shadow:0 0 0 2px rgba(83,226,174,.1)}
</style>
</head>
<body>
  <header>
    <h1>Digital Truth: Спаси Правду</h1>
    <div style="display:flex; gap:16px; align-items:center">
      <div id="caseNo">Дело — 0 / 0</div>
      <div id="rep">Репутация: 0</div>
    </div>
  </header>

  <main>
    <!-- Экран 0: Splash/Hook -->
    <section id="splash" class="panel" style="text-align:center; padding:40px 24px">
      <div class="hero" style="justify-content:center; margin-bottom:16px">
        <div class="badge">Новая миссия • v2.0</div>
      </div>
      <h2 class="title" style="font-size:28px">Digital Truth: Идентификация агента</h2>
      <p class="subtitle" style="margin-bottom:24px">Доступ к базе "Digital Shield" возможен только после регистрации агента.</p>
      <button class="primary" id="btnOnboard" style="padding:12px 24px; font-size:16px">Начать идентификацию</button>
    </section>

    <!-- Экран 1: Объяснение зачем -->
    <section id="onboard-welcome" class="panel" style="display:none">
      <h2 class="title">Добро пожаловать, Агент</h2>
      <div style="background:#0c121b; border-left:3px solid var(--acc); padding:12px 14px; border-radius:6px; margin:16px 0; line-height:1.6; font-size:15px">
        <p style="margin:6px 0">• Мы тестируем вашу цифровую интуицию и навык факт-чека.</p>
        <p style="margin:6px 0">• Регистрация нужна, чтобы настроить миссии и собрать анонимную статистику.</p>
        <p style="margin:6px 0">• Это займёт &lt; 1 минуты.</p>
      </div>
      <div class="footerRow" style="justify-content:flex-start">
        <button class="primary" id="btnFormStart">Заполнить паспортичку</button>
      </div>
    </section>

    <!-- Экран 2: Форма "Паспорт агента" -->
    <section id="onboard-form" class="panel" style="display:none">
      <h2 class="title">Паспорт агента</h2>
      <p style="color:var(--muted); font-size:14px; margin-bottom:16px">Прогресс: Шаг 2 из 3</p>
      <form id="agentForm" style="display:grid; gap:14px">
        <!-- Позывной -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:6px">
            Позывной агента <span style="color:var(--warn)">*</span>
          </label>
          <input type="text" id="callsign" placeholder="Пример: Agent Nova" maxlength="32"
                 style="width:100%; padding:10px 12px; background:#0c121b; border:1px solid #223047; border-radius:10px; color:var(--ink); font-size:14px">
          <small style="color:var(--muted); font-size:12px; margin-top:4px; display:block">Это ваш публичный ник; личных данных не просим.</small>
        </div>

        <!-- Пол -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px">
            Пол <span style="color:var(--warn)">*</span>
            <span style="color:var(--muted); font-weight:400; font-size:12px">(для анализа восприятия)</span>
          </label>
          <div style="display:grid; gap:6px">
            <label class="opt-radio"><input type="radio" name="gender" value="female" required> Женский</label>
            <label class="opt-radio"><input type="radio" name="gender" value="male" required> Мужской</label>
            <label class="opt-radio"><input type="radio" name="gender" value="nonbinary" required> Небинарный</label>
            <label class="opt-radio"><input type="radio" name="gender" value="skip" required> Не указывать</label>
            <label class="opt-radio" style="position:relative">
              <input type="radio" name="gender" value="other" required> Другое
              <input type="text" id="genderOther" placeholder="Укажите" maxlength="20"
                     style="margin-left:24px; padding:6px 8px; width:150px; background:#0c121b; border:1px solid #223047; border-radius:6px; color:var(--ink); font-size:12px; display:none">
            </label>
          </div>
        </div>

        <!-- Возраст -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px">
            Возрастная группа <span style="color:var(--warn)">*</span>
          </label>
          <div style="display:grid; gap:6px">
            <label class="opt-radio"><input type="radio" name="age" value="under18" required> &lt;18 лет</label>
            <label class="opt-radio"><input type="radio" name="age" value="18-25" required> 18–25 лет</label>
            <label class="opt-radio"><input type="radio" name="age" value="26-35" required> 26–35 лет</label>
            <label class="opt-radio"><input type="radio" name="age" value="36-45" required> 36–45 лет</label>
            <label class="opt-radio"><input type="radio" name="age" value="46plus" required> 46+ лет</label>
          </div>
        </div>

        <!-- Регион -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:6px">
            Регион / Город <span style="color:var(--warn)">*</span>
          </label>
          <select id="region" required style="width:100%; padding:10px 12px; background:#0c121b; border:1px solid #223047; border-radius:10px; color:var(--ink); font-size:14px">
            <option value="">—</option>
            <option value="russia">Россия</option>
            <option value="ukraine">Украина</option>
            <option value="belarus">Беларусь</option>
            <option value="kazakhstan">Казахстан</option>
            <option value="other-cis">Другие страны СНГ</option>
            <option value="europe">Европа</option>
            <option value="americas">Америки</option>
            <option value="asia">Азия</option>
            <option value="africa">Африка</option>
            <option value="other">Другое</option>
          </select>
        </div>

        <!-- Образование -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:6px">
            Уровень образования (опц.)
          </label>
          <select id="education" style="width:100%; padding:10px 12px; background:#0c121b; border:1px solid #223047; border-radius:10px; color:var(--ink); font-size:14px">
            <option value="">—</option>
            <option value="secondary">Среднее</option>
            <option value="vocational">Среднее специальное</option>
            <option value="student">Студент</option>
            <option value="bachelor">Высшее (бакалавр)</option>
            <option value="master">Высшее (магистр, PhD)</option>
            <option value="other">Другое</option>
          </select>
        </div>

        <!-- Активность онлайн -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px">
            Онлайн-активность в день (опц.)
          </label>
          <div style="display:grid; gap:6px">
            <label class="opt-radio"><input type="radio" name="activity" value="under2h"> &lt;2ч</label>
            <label class="opt-radio"><input type="radio" name="activity" value="2-5h"> 2–5ч</label>
            <label class="opt-radio"><input type="radio" name="activity" value="5-8h"> 5–8ч</label>
            <label class="opt-radio"><input type="radio" name="activity" value="8plus"> 8+ часов</label>
          </div>
        </div>

        <!-- Платформа -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px">
            Любимая платформа (опц.)
          </label>
          <div style="display:grid; gap:6px">
            <label class="opt-radio"><input type="radio" name="platform" value="instagram"> Instagram</label>
            <label class="opt-radio"><input type="radio" name="platform" value="tiktok"> TikTok</label>
            <label class="opt-radio"><input type="radio" name="platform" value="telegram"> Telegram</label>
            <label class="opt-radio"><input type="radio" name="platform" value="youtube"> YouTube</label>
            <label class="opt-radio"><input type="radio" name="platform" value="x"> X (Twitter)</label>
            <label class="opt-radio"><input type="radio" name="platform" value="vk"> VK</label>
            <label class="opt-radio"><input type="radio" name="platform" value="other"> Другое</label>
          </div>
        </div>

        <!-- Проверка фактов -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px">
            Как часто ты проверяешь факты? (опц.)
          </label>
          <div style="display:grid; gap:6px">
            <label class="opt-radio"><input type="radio" name="factcheck" value="always"> Всегда</label>
            <label class="opt-radio"><input type="radio" name="factcheck" value="sometimes"> Иногда</label>
            <label class="opt-radio"><input type="radio" name="factcheck" value="rarely"> Редко</label>
            <label class="opt-radio"><input type="radio" name="factcheck" value="never"> Никогда</label>
          </div>
        </div>

        <!-- Роль в сети -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px">
            Твоя роль в сети (опц.)
          </label>
          <div style="display:grid; gap:6px">
            <label class="opt-radio"><input type="radio" name="role" value="observer"> Наблюдатель</label>
            <label class="opt-radio"><input type="radio" name="role" value="active"> Активный</label>
            <label class="opt-radio"><input type="radio" name="role" value="creator"> Создатель</label>
            <label class="opt-radio"><input type="radio" name="role" value="analyst"> Аналитик</label>
            <label class="opt-radio"><input type="radio" name="role" value="anon"> Аноним</label>
          </div>
        </div>

        <!-- Цель участия -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px">
            Цель участия (опц.)
          </label>
          <div style="display:grid; gap:6px">
            <label class="opt-radio"><input type="radio" name="goal" value="play"> Играю</label>
            <label class="opt-radio"><input type="radio" name="goal" value="challenge"> Проверить себя</label>
            <label class="opt-radio"><input type="radio" name="goal" value="fakes"> Тема фейков интересует</label>
            <label class="opt-radio"><input type="radio" name="goal" value="research"> Участвую в исследовании</label>
          </div>
        </div>

        <div class="footerRow" style="margin-top:20px; justify-content:space-between">
          <button type="button" class="ghost" id="btnFormBack">Назад</button>
          <button type="button" class="primary" id="btnFormNext">Далее</button>
        </div>
      </form>
    </section>

    <!-- Экран 3: Согласие -->
    <section id="onboard-consent" class="panel" style="display:none">
      <h2 class="title">Проверка данных агента</h2>
      <p style="color:var(--muted); font-size:14px; margin-bottom:16px">Прогресс: Шаг 3 из 3</p>
      
      <!-- Резюме -->
      <div style="background:#0c121b; border:1px solid #223047; border-radius:10px; padding:12px; margin-bottom:16px">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px">
          <div><span style="color:var(--muted)">Позывной:</span> <span id="summaryCallsign">—</span></div>
          <div><span style="color:var(--muted)">Пол:</span> <span id="summaryGender">—</span></div>
          <div><span style="color:var(--muted)">Возраст:</span> <span id="summaryAge">—</span></div>
          <div><span style="color:var(--muted)">Регион:</span> <span id="summaryRegion">—</span></div>
        </div>
      </div>

      <!-- Объяснение данных -->
      <div style="background:rgba(83,226,174,.05); border-left:3px solid var(--acc); padding:12px; border-radius:6px; margin-bottom:16px">
        <p style="margin:0; font-size:14px; line-height:1.5">
          <strong>О данных простыми словами:</strong><br>
          Мы собираем только анонимные ответы и игровые действия (выборы, время реакции, ошибки/успехи). Личных данных (ФИО, телефон и т.п.) — нет.
        </p>
      </div>

      <!-- Чекбоксы согласия -->
      <form id="consentForm" style="display:grid; gap:10px; margin-bottom:16px">
        <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer">
          <input type="checkbox" id="consentData" style="margin-top:3px">
          <span style="font-size:14px; line-height:1.4">Я согласен(сна) на обработку моих анонимных данных для исследовательских целей и улучшения игры.</span>
        </label>
        <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer">
          <input type="checkbox" id="consentAge" style="margin-top:3px">
          <span style="font-size:14px; line-height:1.4">Мне 16 лет и больше. <span style="color:var(--muted)">*</span></span>
        </label>
      </form>

      <!-- Линк "Подробнее" -->
      <p style="text-align:center; margin:12px 0">
        <button type="button" class="ghost" id="btnMoreInfo" style="text-decoration:underline; padding:0">Подробнее о защите данных</button>
      </p>

      <div class="footerRow" style="justify-content:space-between; margin-top:20px">
        <button type="button" class="ghost" id="btnConsentBack">Назад</button>
        <button type="button" class="primary" id="btnActivate" disabled>Активировать профиль агента</button>
      </div>
    </section>

    <!-- Модальное окно "Подробнее" -->
    <div id="infoModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:100; overflow:auto; padding:20px">
      <div style="background:var(--card); border:1px solid #1e2a3b; border-radius:14px; max-width:500px; margin:40px auto; padding:20px">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
          <h3 style="margin:0">Как мы обрабатываем ваши данные</h3>
          <button type="button" class="ghost" id="btnCloseModal" style="padding:4px 8px; font-size:16px">×</button>
        </div>
        <div style="font-size:13px; line-height:1.6; color:var(--ink)">
          <p><strong>Кто обрабатывает данные:</strong> команда проекта "Digital Truth".</p>
          <p><strong>Что собираем:</strong> пол, возрастной диапазон, регион, ответы на вопросы и игровые действия (время реакции, решения, успех/ошибка).</p>
          <p><strong>Цель:</strong> исследование восприятия цифровой информации и улучшение механик игры.</p>
          <p><strong>Правовая основа:</strong> добровольное согласие участника.</p>
          <p><strong>Срок хранения:</strong> до окончания исследования (не более 24 месяцев), затем данные удаляются или остаются только в полностью агрегированном виде.</p>
          <p><strong>Передача третьим лицам:</strong> только в виде обезличенной статистики.</p>
          <p style="color:var(--muted); font-size:12px">За вопросами или отзывом согласия: support@digitaltruth.game</p>
        </div>
        <div class="footerRow" style="justify-content:center; margin-top:16px">
          <button type="button" class="primary" id="btnCloseInfo">Понял</button>
        </div>
      </div>
    </div>

    <!-- Стартовый экран (после онбординга) -->
    <section id="start" class="panel" style="display:none">
      <div class="hero">
        <div class="badge">Цифровой спасотряд • v2.0</div>
      </div>
      <h2 class="title">Ты — детектив фактов</h2>
      <p class="subtitle">Классифицируй: <span class="kbd">Правда</span> или <span class="kbd">Ложь</span>. Затем прими решение — <b>кого спасти</b>. Набери репутацию и получи похвалу Совета.</p>
      <div class="footerRow" style="justify-content:flex-start; margin-top:16px">
        <button class="primary" id="btnStart">Начать расследование</button>
        <button class="ghost" id="btnHow">Правила</button>
      </div>
    </section>

    <!-- Экран дела -->
    <section id="case" class="grid" style="display:none">
      <div class="panel">
        <div class="meta">
          <span class="tag" id="caseTag">Incident • </span>
          <span class="tag" id="caseDifficulty">Уровень</span>
        </div>
        <h3 class="title" id="caseTitle">Заголовок дела</h3>
        <p class="subtitle" id="caseNarrative">Описание</p>

        <h4 style="margin:12px 0 8px">Доказательства:</h4>
        <div class="evidence" id="evList"></div>

        <div class="footerRow">
          <span class="scoreline" id="evScore">Отмечено: 0 / 0</span>
        </div>
      </div>

      <div class="panel">
        <h4 style="margin:8px 0">Решение: кого спасти?</h4>
        <div class="choice" id="choiceBox"></div>
        <div class="footerRow">
          <button id="btnCheck" class="primary" disabled>Проверить дело</button>
          <button id="btnSkip" class="">Пропустить</button>
        </div>
        <div style="margin-top:8px; font-size:13px; color:var(--muted)">Совет: отметь все доказательства как <i>Правда</i> или <i>Ложь</i>, затем выбери, кого спасать.</div>
      </div>
    </section>

    <!-- Финал -->
    <section id="end" class="panel end" style="display:none">
      <div class="rank" id="rank">Ранг</div>
      <h2 id="endTitle">Миссия завершена</h2>
      <p id="endText">Текст</p>
      <div class="footerRow" style="justify-content:center">
        <button class="primary" id="btnRestart">Сыграть ещё</button>
        <button id="btnShare">Скопировать результат</button>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

<script>
/** ======== ДАННЫЕ СЮЖЕТОВ (можно расширять) ======== */
const CASES = [
  {
    tag: "Фейк-новости",
    difficulty: "Лёгкий",
    title: "Взлом аккаунта или отмазка?",
    narrative: "Девушка заявляет, что её аккаунт рассылал скам из-за взлома. Система фиксирует входы с её обычного устройства и IP.",
    evidence: [
      { text: "Лог входов с неизменного IP за последние 7 дней", isTruth: true, hint: "Стабильный IP снижает вероятность взлома." },
      { text: "Посты со скам-ссылками написаны в её обычное время активности", isTruth: true, hint: "Временные паттерны совпадают." },
      { text: "Скрин «ошибки входа» без метаданных и даты", isTruth: false, hint: "Скрин легко подделать, нет EXIF/даты." },
    ],
    choices: [
      { id:"victim", label:"Спасти девушку: блок не накладывать" },
      { id:"system", label:"Спасти систему: наложить ограничение и предупредить подписчиков" }
    ],
    correctChoice: "system",
    praise: "Верно. Ты защитил аудиторию и не дал манипуляции распространиться."
  },
  {
    tag: "Поддельные профили",
    difficulty: "Средний",
    title: "Инфлюенсер или клон?",
    narrative: "Аккаунт якобы известного стримера просит донаты на «срочное лечение» через сомнительный кошелек.",
    evidence: [
      { text: "Домен ссылки зарегистрирован 2 дня назад", isTruth: true, hint:"Свежий домен — красный флаг."},
      { text: "Официальный аккаунт отрицает сбор средств", isTruth: true, hint:"Прямое опровержение."},
      { text: "Фото со сторис совпадает, но найдено в гугле год назад", isTruth: true, hint:"Реюз старого медиа."},
      { text: "Знак верификации отсутствует", isTruth: true, hint:"Нет подтверждения личности."},
    ],
    choices: [
      { id:"clone", label:"Спасти аудиторию: пометить как фишинг и оповестить" },
      { id:"donate", label:"Спасти сбор: разместить ссылку" }
    ],
    correctChoice: "clone",
    praise: "Чисто! Клон обезврежен, доверие сохранено."
  },
  {
    tag: "Дипфейк",
    difficulty: "Средний",
    title: "Видео-скандал",
    narrative: "Рассылается ролик, где топ-менеджер якобы признаёт махинации. Команда утверждает, что это дипфейк.",
    evidence: [
      { text: "Несовпадение теней и мигания глаз", isTruth: true, hint:"Классические признаки дипфейка."},
      { text: "Аудиодорожка содержит артефакты стыковки", isTruth: true, hint:"Слышны склейки."},
      { text: "Оригинал речи найден и он другой", isTruth: true, hint:"Источник опровергает ролик."},
      { text: "Мета-данные файла удалены", isTruth: true, hint:"Подозрительно для оригинала."}
    ],
    choices: [
      { id:"manager", label:"Спасти человека: пометить видео как дипфейк" },
      { id:"viral", label:"Спасти вирусность: оставить как есть" }
    ],
    correctChoice: "manager",
    praise: "Уважуха. Репутацию невиновного сохранили."
  },
  {
    tag: "Кибербуллинг",
    difficulty: "Сложный",
    title: "Хейт-кампания",
    narrative: "О студентке распространяют «факты» с анонимного форума. Скриншоты без источника, эмоции накалены.",
    evidence: [
      { text: "Скриншоты без прямых ссылок/архива", isTruth: false, hint:"Без ссылки — ноль доверия."},
      { text: "Набор одинаковых ошибок в орфографии у разных аккаунтов", isTruth: true, hint:"Один автор — несколько масок."},
      { text: "Нет совпадений в официальных реестрах", isTruth: true, hint:"Факты не подтверждаются."}
    ],
    choices: [
      { id:"student", label:"Спасти студентку: снять публикации, приложить разбор" },
      { id:"mob", label:"Спасти толпу: оставить контент от «свободы слова»" }
    ],
    correctChoice: "student",
    praise: "Ты разрубил буллинг по правилам фактчека."
  },
  {
    tag: "Игровое мошенничество",
    difficulty: "Сложный",
    title: "Дроп-схема",
    narrative: "Игрок хвастается «легальным багом» для дропа скинов и продаёт гайд.",
    evidence: [
      { text: "Жалобы от 15 пользователей на кражу аккаунтов после «гайда»", isTruth: true, hint:"Косвенное, но сильное доказ."},
      { text: "Видео-демо — монтаж с резкими склейками", isTruth: true, hint:"Подлог очевиден."},
      { text: "Разработчик подтверждает, что такого бага нет", isTruth: true, hint:"Первичный источник всё решает."},
      { text: "Автор «гайда» скрывает дату регистрации кошелька", isTruth: true, hint:"Признак мошенничества."},
    ],
    choices: [
      { id:"community", label:"Спасти сообщество: бан схемы и предупреждение" },
      { id:"seller", label:"Спасти продавца: разрешить продажи" }
    ],
    correctChoice: "community",
    praise: "Комьюнити благодарно. Экономику спасли."
  }
];

/** ======== СОСТОЯНИЕ И ЛОГИКА ======== */
let state = {
  idx: 0,
  rep: 0,
  answers: {} // { evIndex: true/false }, choiceId
};

const $ = sel => document.querySelector(sel);
const $all = sel => document.querySelectorAll(sel);

// ========== ONBOARDING STATE ==========
let agentData = JSON.parse(localStorage.getItem("agentData") || "null");

function hideAllSections(){
  ["splash", "onboard-welcome", "onboard-form", "onboard-consent", "start", "case", "end"].forEach(id=>{
    const el = $(`#${id}`);
    if(el) el.style.display = "none";
  });
}

function toast(msg){
  const t = $("#toast"); t.textContent = msg; t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2300);
}

// ========== ONBOARDING FLOW ==========
function showOnboardWelcome(){
  hideAllSections();
  $("#onboard-welcome").style.display = "block";
}

function showOnboardForm(){
  hideAllSections();
  $("#onboard-form").style.display = "block";
  // Reset form
  $("#agentForm").reset();
  updateFormValidation();
}

function showOnboardConsent(){
  hideAllSections();
  const form = document.getElementById("agentForm");
  const fd = new FormData(form);
  
  agentData = {
    callsign: document.getElementById("callsign").value || "Агент",
    gender: fd.get("gender") || "—",
    age: fd.get("age") || "—",
    region: fd.get("region") || "—",
    education: fd.get("education"),
    activity: fd.get("activity"),
    platform: fd.get("platform"),
    factcheck: fd.get("factcheck"),
    role: fd.get("role"),
    goal: fd.get("goal"),
  };

  // Update summary
  const genderLabels = { female: "Женский", male: "Мужской", nonbinary: "Небинарный", skip: "Не указан", other: document.getElementById("genderOther").value };
  const ageLabels = { "under18": "<18", "18-25": "18–25", "26-35": "26–35", "36-45": "36–45", "46plus": "46+" };
  const regionOptions = document.getElementById("region").options;
  const regionLabel = regionOptions[regionOptions.selectedIndex]?.textContent || "—";

  $("#summaryCallsign").textContent = agentData.callsign;
  $("#summaryGender").textContent = genderLabels[agentData.gender] || agentData.gender;
  $("#summaryAge").textContent = ageLabels[agentData.age] || agentData.age;
  $("#summaryRegion").textContent = regionLabel;

  // Reset consent checkboxes
  document.getElementById("consentData").checked = false;
  document.getElementById("consentAge").checked = false;
  updateConsentValidation();

  $("#onboard-consent").style.display = "block";
}

function completeOnboarding(){
  agentData.completedAt = new Date().toISOString();
  localStorage.setItem("agentData", JSON.stringify(agentData));
  toast(`Идентификация завершена. Добро пожаловать в миссию, ${agentData.callsign}!`);
  hideAllSections();
  $("#start").style.display = "block";
  updateHeader();
}

function updateFormValidation(){
  const callsign = document.getElementById("callsign").value.trim();
  const gender = [...document.querySelectorAll('input[name="gender"]')].some(r=>r.checked);
  const age = [...document.querySelectorAll('input[name="age"]')].some(r=>r.checked);
  const region = document.getElementById("region").value;
  
  const isValid = callsign && gender && age && region;
  document.getElementById("btnFormNext").disabled = !isValid;
}

function updateConsentValidation(){
  const data = document.getElementById("consentData").checked;
  const age = document.getElementById("consentAge").checked;
  document.getElementById("btnActivate").disabled = !(data && age);
}

function showInfoModal(){
  document.getElementById("infoModal").style.display = "block";
}

function closeInfoModal(){
  document.getElementById("infoModal").style.display = "none";
}

// ========== GENDER "OTHER" FIELD ==========
document.addEventListener("DOMContentLoaded", ()=>{
  const genderOther = document.getElementById("genderOther");
  document.querySelectorAll('input[name="gender"]').forEach(radio=>{
    radio.addEventListener("change", ()=>{
      if(radio.value === "other"){
        genderOther.style.display = "block";
        genderOther.focus();
      } else {
        genderOther.style.display = "none";
        genderOther.value = "";
      }
    });
  });

  // Form listeners
  document.getElementById("callsign").addEventListener("input", updateFormValidation);
  document.getElementById("region").addEventListener("change", updateFormValidation);
  document.querySelectorAll('input[name="gender"], input[name="age"]').forEach(el=>{
    el.addEventListener("change", updateFormValidation);
  });

  // Consent listeners
  document.getElementById("consentData").addEventListener("change", updateConsentValidation);
  document.getElementById("consentAge").addEventListener("change", updateConsentValidation);

  // Modal listeners
  document.getElementById("btnMoreInfo").addEventListener("click", showInfoModal);
  document.getElementById("btnCloseModal").addEventListener("click", closeInfoModal);
  document.getElementById("btnCloseInfo").addEventListener("click", closeInfoModal);

  // Onboarding button listeners
  document.getElementById("btnOnboard").addEventListener("click", showOnboardWelcome);
  document.getElementById("btnFormStart").addEventListener("click", showOnboardForm);
  document.getElementById("btnFormBack").addEventListener("click", showOnboardWelcome);
  document.getElementById("btnFormNext").addEventListener("click", showOnboardConsent);
  document.getElementById("btnConsentBack").addEventListener("click", showOnboardForm);
  document.getElementById("btnActivate").addEventListener("click", completeOnboarding);

  // Close modal on background click
  document.getElementById("infoModal").addEventListener("click", (e)=>{
    if(e.target.id === "infoModal") closeInfoModal();
  });
});

function updateHeader(){
  $("#rep").textContent = `Репутация: ${state.rep}`;
  $("#caseNo").textContent = `Дело — ${state.idx+1} / ${CASES.length}`;
}

function renderCase(){
  const c = CASES[state.idx];
  $("#caseTag").textContent = c.tag;
  $("#caseDifficulty").textContent = c.difficulty;
  $("#caseTitle").textContent = c.title;
  $("#caseNarrative").textContent = c.narrative;

  // Evidence list
  const evBox = $("#evList"); evBox.innerHTML = "";
  state.answers = { ev: Array(c.evidence.length).fill(null), choice: null };

  c.evidence.forEach((ev, i)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="meta"><span class="tag">Доказательство #${i+1}</span></div>
      <div class="text">${ev.text}</div>
      <div class="controls">
        <button class="truth" data-kind="truth" data-i="${i}">Правда</button>
        <button class="lie" data-kind="lie" data-i="${i}">Ложь</button>
        <button class="ghost" data-kind="hint" data-i="${i}">Подсказка</button>
      </div>
    `;
    evBox.appendChild(card);
  });

  // Choices
  const choiceBox = $("#choiceBox"); choiceBox.innerHTML = "";
  c.choices.forEach((opt)=>{
    const row = document.createElement("label");
    row.className = "opt";
    row.innerHTML = `
      <input type="radio" name="who" value="${opt.id}">
      <div><div style="font-weight:700; margin-bottom:4px">${opt.label}</div>
      <div style="color:var(--muted); font-size:13px">Решение повлияет на репутацию.</div></div>
    `;
    choiceBox.appendChild(row);
  });

  $("#btnCheck").disabled = true;
  updateEvScore();
  updateHeader();
}

function updateEvScore(){
  const c = CASES[state.idx];
  const done = state.answers.ev.filter(v=>v!==null).length;
  $("#evScore").textContent = `Отмечено: ${done} / ${c.evidence.length}`;
  maybeEnableCheck();
}

function maybeEnableCheck(){
  const c = CASES[state.idx];
  const allEv = state.answers.ev.every(v=>v!==null);
  const hasChoice = !!state.answers.choice;
  $("#btnCheck").disabled = !(allEv && hasChoice);
}

function onEvidenceClick(e){
  const btn = e.target.closest("button");
  if(!btn) return;
  const i = Number(btn.dataset.i);
  const kind = btn.dataset.kind;

  if(kind === "hint"){
    toast(CASES[state.idx].evidence[i].hint || "Подсказка недоступна");
    return;
  }
  // truth/lie
  state.answers.ev[i] = (kind === "truth");
  // визуал переключения: выделим активную кнопку
  const card = btn.parentElement;
  [...card.querySelectorAll("button.truth,button.lie")].forEach(b=>{
    b.style.outline = "";
    b.style.filter = "";
    b.style.opacity = ".8";
  });
  btn.style.outline = "2px solid #88c";
  btn.style.filter = "brightness(1.1)";
  btn.style.opacity = "1";
  updateEvScore();
}

function onChoiceChange(e){
  if(e.target && e.target.name === "who"){
    state.answers.choice = e.target.value;
    maybeEnableCheck();
  }
}

function checkCase(){
  const c = CASES[state.idx];
  let points = 0;
  // за каждое верное доказательство +1
  c.evidence.forEach((ev, i)=>{
    if(state.answers.ev[i] === ev.isTruth) points += 1;
  });
  // за верный выбор +2
  if(state.answers.choice === c.correctChoice) points += 2;

  state.rep += points;
  toast(`Дело закрыто: +${points} репутации`);
  nextCase();
}

function nextCase(){
  state.idx += 1;
  if(state.idx >= CASES.length){
    endGame();
  }else{
    renderCase();
  }
}

function endGame(){
  $("#case").style.display = "none";
  $("#end").style.display = "grid";
  updateHeader();

  const maxRep = CASES.reduce((acc,c)=>acc + c.evidence.length + 2, 0);
  const ratio = state.rep / maxRep;

  let rank = "Аналитик-новобранец";
  let praise = "Неплохо. База есть — масштабируем качество решений.";
  if(ratio >= .35){ rank = "Фактчекер"; praise = "Ты уверенно отличаешь шум от сигналов."; }
  if(ratio >= .6){ rank = "Куратор правды"; praise = "Стабильно спасаешь то, что важно — людей и данные."; }
  if(ratio >= .8){ rank = "Спаситель правды"; praise = "Совет аплодирует стоя. Твой разбор — эталон.";}

  $("#rank").textContent = rank;
  $("#endTitle").textContent = "Миссия завершена";
  $("#endText").textContent = `Итоговая репутация: ${state.rep}. ${praise}`;
}

function shareResult(){
  const text = `Я прошёл Digital Truth и получил репутацию ${state.rep}! #СпасиПравду`;
  navigator.clipboard.writeText(text).then(()=>toast("Скопировано в буфер обмена"));
}

function restart(){
  state = { idx:0, rep:0, answers:{} };
  $("#end").style.display = "none";
  $("#start").style.display = "block";
  updateHeader();
}

/** ======== ИНИЦИАЛИЗАЦИЯ UI ======== */
$("#btnStart").addEventListener("click", ()=>{
  $("#start").style.display = "none";
  $("#case").style.display = "grid";
  renderCase();
});

$("#btnHow").addEventListener("click", ()=>{
  toast("Отмечай доказательства как Правда/Ложь и выбери, кого спасти. Баллы = точность + верный выбор.");
});

$("#evList").addEventListener("click", onEvidenceClick);
$("#choiceBox").addEventListener("change", onChoiceChange);
$("#btnCheck").addEventListener("click", checkCase);
$("#btnSkip").addEventListener("click", ()=>{ toast("Дело пропущено"); nextCase(); });
$("#btnRestart").addEventListener("click", restart);
$("#btnShare").addEventListener("click", shareResult);

// ========== INIT ==========
// Show onboarding if not completed
if(!agentData || !agentData.completedAt){
  hideAllSections();
  $("#splash").style.display = "block";
} else {
  hideAllSections();
  $("#start").style.display = "block";
}
updateHeader();
</script>
</body>
</html>
